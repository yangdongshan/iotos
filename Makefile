

ifeq ($(V),)
	Q = @
else
	Q :=
endif
export Q


ROOTDIR = $(shell pwd)
export ROOTDIR

SCRIPTSDIR = $(ROOTDIR)/scripts
export SCRIPTSDIR

# include system .config which is generated by make menuconfig
#-include .config

# include config
-include $(SCRIPTSDIR)/config.mk

PROJNAME ?= CONFIG_PROJECT_NAME 

KCONFIGDIR = $(ROOTDIR)/kconfig
KCONFIGFILE = $(ROOTDIR)/Kconfig


#CFLAGS += -include $(ROOTDIR)/include/generated/autoconf.h

ARFLAGS +=

LDFLAGS +=


LINKER_LD := $(ROOTDIR)/boot/linker.ld
GRUB_CFG := $(ROOTDIR)/tools/grub.cfg

ARCH_CHIP_DIR := arch/chip
ARCH_BOARD_DIR := arch/board
ARCH_BOOT_DIR := arch/boot

# library directory
LIBDIR := arch/chip \
          arch/board \
		  init \
		  kernel \
		  libc

LIBS = $(addprefix $(ROOTDIR)/,$(foreach dir, $(LIBDIR), $(dir)/lib$(dir).a))
export LIBS

LDDIR += $(addprefix -L$(ROOTDIR)/,$(LIBDIR))
LDLIB += $(addprefix -l,$(LIBDIR))

CFLAGS += -I$(ROOTDIR)/$(ARCH_CHIP_DIR)/include \
		  -I$(ROOTDIR)/$(ARCH_CHIP_DIR)/peripherals/include \
		  -I$(ROOTDIR)/$(ARCH_BOOT_DIR)/include \
          -I$(ROOTDIR)/include \
          -I$(ROOTDIR)/libc/include

export LDDIR
export LDLIB

export CFLAGS
export ARFLAGS
export LDFLAGS

ELF=$(ROOTDIR)/$(PROJNAME).elf

all: $(ELF)

$(ELF): link_dir lib
	#$(Q) $(MAKE) -C $(ARCH_BOOT_DIR) binary elf=$@ linker_file=$(LINKER_LD)

link_dir:
	$(Q) if [ ! -e $(ARCH_CHIP_DIR) ]; then cp -r arch/$(ARCH)/$(CHIP)/chip $(ARCH_CHIP_DIR); fi
	$(Q) if [ ! -e $(ARCH_BOARD_DIR) ]; then cp -r arch/$(ARCH)/$(CHIP)/$(BOARD) $(ARCH_BOARD_DIR); fi
	$(Q) if [ ! -e $(ARCH_BOOT_DIR) ]; then cp -r arch/$(ARCH)/$(CHIP)/boot $(ARCH_BOOT_DIR); fi

lib: $(LIBDIR)
	$(Q) $(foreach dir, $(LIBDIR), \
		$(MAKE) -C $(dir) obj || exit "$$?";\
		$(MAKE) -C $(dir) lib libname=lib$(dir).a || exit "$$?";)


.PHONY: menuconfig distclean silentoldconfig clean launch_qemu download

menuconfig: $(KCONFIGDIR)/mconf $(KCONFIGDIR)/conf
	$(Q) $< -s $(KCONFIGFILE)
	$(Q) $(MAKE) silentoldconfig

$(KCONFIGDIR)/mconf:
	$(Q) $(MAKE) -C $(KCONFIGDIR)

silentoldconfig: $(KCONFIGDIR)/conf
	$(Q) mkdir -p include/generated include/config
	$(Q) $< -s --silentoldconfig $(KCONFIGFILE)

clean:
	$(Q) $(foreach dir, $(ARCH_BOOT_DIR) $(LIBDIR), $(MAKE) -C $(dir) clean;)
	$(Q) -rm -f $(ELF) $(ISO)

distclean: clean
	$(Q) $(MAKE) -C $(KCONFIGDIR) clean
	$(Q) -rm -rf $(ARCH_CHIP_DIR) $(ARCH_BOARD_DIR) $(ARCH_BOOT_DIR)
	$(Q) -rm -rf include/generated include/config .config

launch_qemu: $(ISO)
	$(Q) $(QEMU) -cdrom $(ISO) -nographic #-enable-kvm

download:
	$(Q) st-flash 
